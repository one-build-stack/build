name: Build

on:
  workflow_dispatch:
    inputs:
      runs_on:
        required: false
        default: ubuntu-latest
      repo_owner:
        required: true
      repo_name:
        required: true
      branch:
        required: true
        default: main
      commands:
        required: true
        default: bun run build
      output_paths:
        required: true
        default: dist
      callback_url:
        required: false
        default: ""

permissions:
  contents: read
  actions: read

env:
  GITLAB_URL: ${{ secrets.GITLAB_URL }}
  GITLAB_USERNAME: ${{ secrets.GITLAB_USERNAME }}
  GITLAB_PASSWORD: ${{ secrets.GITLAB_PASSWORD }}
  WORKER_API_URL: ${{ secrets.WORKER_API_URL }}

jobs:
  build:
    runs-on: ${{ inputs.runs_on || 'ubuntu-latest' }}

    steps:
    # ========================
    # Checkout
    # ========================
    - name: 检出工作流仓库
      uses: actions/checkout@v4

    # ========================
    # Start time
    # ========================
    - name: 记录开始时间
      run: |
        echo "RUN_STARTED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_ENV"

    # ========================
    # Toolchains
    # ========================
    - name: 安装 Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: 安装 Rust
      uses: dtolnay/rust-toolchain@stable

    # ========================
    # Init env
    # ========================
    - name: 初始化工作环境
      shell: bash
      run: |
        set -euo pipefail
        sudo apt-get -qq update || true
        sudo apt-get -qq install -y jq zip || true
        bun add crypto-js child_process

    # ========================
    # Callback: running
    # ========================
    - name: 回调（开始 running）
      if: ${{ inputs.callback_url != '' }}
      env:
        CALLBACK_URL: ${{ inputs.callback_url }}
      run: |
        set -euo pipefail
        curl -sS \
          -H "Content-Type: application/json" \
          -X POST "${CALLBACK_URL}" \
          --data '{"status":"running"}' >/dev/null || true

    # ========================
    # Clone target project
    # ========================
    - name: 克隆目标项目
      shell: bash
      env:
        REPO_OWNER: ${{ inputs.repo_owner }}
        REPO_NAME: ${{ inputs.repo_name }}
        BRANCH: ${{ inputs.branch }}
      run: |
        set -euo pipefail
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        BASE="${GITLAB_URL:-https://gitlab.com}"
        USER="${GITLAB_USERNAME:-oauth2}"
        PASS="${GITLAB_PASSWORD:-}"
        HOST="${BASE#https://}"

        git clone -q --branch "${BRANCH}" \
          "https://${USER}:${PASS}@${HOST}/${REPO_OWNER}/${REPO_NAME}.git" \
          target-project

    # ========================
    # Install deps
    # ========================
    - name: 安装依赖
      working-directory: target-project
      run: bun install

    # ========================
    # Run build commands
    # ========================
    - name: 执行命令
      working-directory: target-project
      shell: bash
      run: |
        set -euo pipefail
        CMDS=$(printf '%s' "${{ inputs.commands }}" | tr -d '\r')
        IFS=';' read -ra ARR <<< "$CMDS"
        for cmd in "${ARR[@]}"; do
          cmd="$(echo "$cmd" | xargs)"
          [ -z "$cmd" ] && continue
          bun "$GITHUB_WORKSPACE/.github/workflows/run_interactive_command.ts" "$cmd"
        done

    # ========================
    # Zip outputs
    # ========================
    - name: 汇总输出并打包
      working-directory: target-project
      shell: bash
      run: |
        set -euo pipefail
        TS=$(date +"%Y%m%d-%H%M%S")
        ZIP_FILE="build-${TS}.zip"

        RAW=$(printf '%s' "${{ inputs.output_paths }}" | tr -d '\r')
        IFS=';' read -ra PATHS <<< "$RAW"

        for p in "${PATHS[@]}"; do
          if [ -d "$p" ]; then
            (cd "$(dirname "$p")" && zip -r "$OLDPWD/$ZIP_FILE" "$(basename "$p")" >/dev/null)
          elif [ -f "$p" ]; then
            zip -j "$ZIP_FILE" "$p" >/dev/null
          fi
        done

        echo "ZIP_FILE=$ZIP_FILE" >> "$GITHUB_ENV"

    # ========================
    # Upload via Worker proxy
    # ========================
    - name: 上传构建产物到 R2（Worker 代理）
      working-directory: target-project
      shell: bash
      run: |
        set -euo pipefail

        echo "Uploading ${ZIP_FILE} ..."

        RESPONSE=$(curl -sS -X POST "${WORKER_API_URL}/upload" \
          -F "file=@${ZIP_FILE}")

        echo "Worker response: $RESPONSE"

        KEY=$(echo "$RESPONSE" | jq -r '.key')

        if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
          echo "❌ Upload failed"
          exit 1
        fi

        echo "ARTIFACT_KEY=$KEY" >> "$GITHUB_ENV"

    # ========================
    # Build download URL
    # ========================
    - name: 构造下载地址
      shell: bash
      run: |
        set -euo pipefail
        DOWNLOAD_URL="${WORKER_API_URL}/download?key=${ARTIFACT_KEY}"
        echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> "$GITHUB_ENV"

    # ========================
    # Callback: finished
    # ========================
    - name: 回调（结束）
      if: ${{ always() && inputs.callback_url != '' }}
      shell: bash
      env:
        OWNER: ${{ github.repository_owner }}
        REPO: ${{ github.event.repository.name }}
        RUN_ID: ${{ github.run_id }}
        CALLBACK_URL: ${{ inputs.callback_url }}
      run: |
        set -euo pipefail

        case "${{ job.status }}" in
          success) STATUS="success" ;;
          failure) STATUS="failed" ;;
          cancelled) STATUS="cancelled" ;;
          *) STATUS="failed" ;;
        esac

        RUN_URL="https://github.com/${OWNER}/${REPO}/actions/runs/${RUN_ID}"
        DOWNLOAD_URL="${DOWNLOAD_URL:-}"

        payload=$(jq -n \
          --arg status "$STATUS" \
          --arg run_url "$RUN_URL" \
          --arg download_url "$DOWNLOAD_URL" \
          '{status: $status, github_run_url: $run_url, download_url: $download_url}')

        curl -sS \
          -H "Content-Type: application/json" \
          -X POST "${CALLBACK_URL}" \
          --data "$payload" >/dev/null || true
